
Pre-configuration in Snowflake such as creating role, creating user, creating schemas, creating stage, granting permissions

SHOW ROLES;

--- CREATE ROLE BY CONNECTION WITH DBT
USE ROLE USERADMIN ;

CREATE ROLE DBT_EXECUTOR_ROLE;

COMMENT ON  ROLE DBT_EXECUTOR_ROLE IS 'Role for the users running DMT models';

--- SET UP WAREHOUSE SUSPENDS AUTOMATICALLY
USE ROLE SYSADMIN;

ALTER WAREHOUSE "COMPUTE_WH" SET
    WAREHOUSE_SIZE = 'XSMALL'
    AUTO_SUSPEND = 60
    AUTO_RESUME = TRUE 
    COMMENT = 'Default Warehouse';


--- GIVE PRIVILEGIES USER RUNS AND USE MACHINE WH
-- INITIALLY GIVE PRIVILEGIES ROLE SYSADMIN 
USE ROLE ACCOUNTADMIN;

GRANT OWNERSHIP ON WAREHOUSE COMPUTE_WH TO ROLE SYSADMIN;

--- LATER GIVE PRIVILGIES SPECIFICS NEW USER, because Accountadmin user never grant privilegies to new users.
USE ROLE SYSADMIN;

GRANT CREATE DATABASE ON ACCOUNT TO ROLE DBT_EXECUTOR_ROLE;

GRANT USAGE ON WAREHOUSE COMPUTE_WH TO ROLE DBT_EXECUTOR_ROLE;

CREATE DATABASE TRACKING_PORTAFOLIO
    COMMENT = 'Database by project portfolio tracking';


--- Create Schemas and Stage
CREATE SCHEMA SOURCE_DATA_STG_SOURCE ;

CREATE SCHEMA SOURCE_DATA_REFINED ;

CREATE SCHEMA SOURCE_DATA_DMT_PORTAFOLIO ;

CREATE SCHEMA STG_SOURCE ;

USE SCHEMA STG_SOURCE;

CREATE STAGE STG_RAW;

CREATE OR REPLACE SCHEMA SOURCE_DATA_STG_SOURCE;
    
---- PUT ROLE TO USER
USE ROLE USERADMIN;

--- Create user to assign the new role to guarantee good practices
CREATE USER IF NOT EXISTS DBT_EXECUTOR    -------  CREATE THE USER
    COMMENT = 'User executions DBT comands'
    PASSWORD = '12345'
    DEFAULT_WAREHOUSE = 'COMPUTE_WH'
    DEFAULT_ROLE = 'DBT_EXECUTOR_ROLE';

----- Assign role to new user
GRANT ROLE DBT_EXECUTOR_ROLE TO USER DBT_EXECUTOR

---- Grant permissions role DBT_EXECUTOR to the database

-- USAGE
GRANT USAGE ON DATABASE TRACKING_PORTAFOLIO TO ROLE DBT_EXECUTOR_ROLE;

-- USAGE to schema
GRANT USAGE ON ALL SCHEMAS IN DATABASE TRACKING_PORTAFOLIO TO ROLE DBT_EXECUTOR_ROLE;

-- SELECT all tables
GRANT SELECT ON ALL TABLES IN DATABASE TRACKING_PORTAFOLIO TO ROLE DBT_EXECUTOR_ROLE;

-- SELECT future tables
GRANT SELECT ON FUTURE TABLES IN DATABASE TRACKING_PORTAFOLIO TO ROLE DBT_EXECUTOR_ROLE;

------ Grant permissions role DBT_EXECUTOR to schema STG_SOURCE
--- Create tables and Views
GRANT CREATE TABLE, CREATE VIEW ON SCHEMA TRACKING_PORTAFOLIO.STG_SOURCE TO ROLE DBT_EXECUTOR_ROLE;

--- Create File Format
GRANT CREATE FILE FORMAT ON SCHEMA TRACKING_PORTAFOLIO.STG_SOURCE TO ROLE DBT_EXECUTOR_ROLE ;

--- Create Views
GRANT CREATE TABLE, CREATE VIEW ON SCHEMA TRACKING_PORTAFOLIO.SOURCE_DATA_STG_SOURCE TO ROLE DBT_EXECUTOR_ROLE;


--- For Snowflake STAGES, can only grant permissions to READ and WRITE
GRANT READ ON STAGE TRACKING_PORTAFOLIO.STG_SOURCE.STG_RAW TO ROLE DBT_EXECUTOR_ROLE;

GRANT WRITE ON STAGE TRACKING_PORTAFOLIO.STG_SOURCE.STG_RAW TO ROLE DBT_EXECUTOR_ROLE;

------ Grant permissions role DBT_EXECUTOR to schema SOURCE_DATA_REFINED
--- Create tables and Views
GRANT CREATE TABLE, CREATE VIEW ON SCHEMA TRACKING_PORTAFOLIO.SOURCE_DATA_REFINED TO ROLE DBT_EXECUTOR_ROLE;

--- Create Views
GRANT CREATE TABLE, CREATE VIEW ON SCHEMA TRACKING_PORTAFOLIO.SOURCE_DATA_REFINED TO ROLE DBT_EXECUTOR_ROLE;

------ Grant permissions role DBT_EXECUTOR to schema SOURCE_DATA_DMT_PORTAFOLIO
--- Create tables and Views
GRANT CREATE TABLE, CREATE VIEW ON SCHEMA TRACKING_PORTAFOLIO.SOURCE_DATA_DMT_PORTAFOLIO TO ROLE DBT_EXECUTOR_ROLE;

--- Create Views
GRANT CREATE TABLE, CREATE VIEW ON SCHEMA TRACKING_PORTAFOLIO.SOURCE_DATA_DMT_PORTAFOLIO TO ROLE DBT_EXECUTOR_ROLE;
